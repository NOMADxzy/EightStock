## 微服务

有效的拆分应用，实现敏捷开发和部署

![微服务](https://pic1.zhimg.com/80/v2-98875c4763fdac25b0f67f9f557a3fc8_1440w.webp)

#### 1、客户端如何访问这些服务

后台N个服务和UI之间一般会一个代理或者叫API Gateway，他的作用包括：

① 提供统一服务入口，让微服务对前台透明

② 聚合后台的服务，节省流量，提升性能

③ 提供安全，过滤，流控等API管理功能

最重要的作 用是为前台（通常是移动应用）提供后台服务的聚合，提供一个统一的服务出口，解除他们之间的耦合。

#### 2、每个服务之间如何通信

所有的微服务都是独立的Java进程跑在独立的虚拟机上，所以服务间的通信就是IPC（inter process communication），已经有很多成熟的方案。现在基本最通用的有两种方式：

同步调用（RPC，REST）：

```
同步调用比较简单，一致性强，但是容易出调用问题，性能体验上也会差些，特别是调用层次多的时候。一般REST基于HTTP，更容易实现，更容易被接受，服务端实现技术也更灵活些，各个语言都能支持，同时能跨客户端，对客户端没有特殊的要求，只要封装了HTTP的SDK就能调用，所以相对使用的广一些。RPC也有自己的优点，传输协议更高效，安全更可控
```

异步消息调用：

```
异步消息的方式在分布式系统中有特别广泛的应用，他既能减低调用服务之间的耦合，又能成为调用之间的缓冲，确保消息积压不会冲垮被调用方，同时能保证调用方的服务体验，继续干自己该干的活，不至于被后台性能拖慢。不过需要付出的代价是一致性的减弱，需要接受数据最终一致性；
```

#### 3、如此多的服务，如何实现？

**客户端做：**优点是架构简单，扩展灵活，只对服务注册器依赖。缺点是客户端要维护所有调用服务的地址，有技术难度，一般大公司都有成熟的内部框架支持，比如Dubbo。

**服务端做：**优点是简单，所有服务对于前台调用方透明，一般在小公司在云服务上部署的应用采用的比较多。

![微服务发现](https://pic4.zhimg.com/80/v2-d8e6d2d496ada2a8e0d5487003e90ba7_1440w.webp)

#### 4、服务挂了，如何解决

①重试机制

②限流

③熔断机制

④负载均衡

⑤降级（本地缓存）

#### 5、常见的设计模式和应用

**1、聚合器微服务设计模式**v



![img](https://pic4.zhimg.com/80/v2-8631f380794928d9b98fedf7be8ffdab_1440w.webp)

聚合器调用多个服务实现应用程序所需的功能。它可以是一个简单的Web页面，将检索到的数据进行处理展示。它也可以是一个更高层次的组合微服务，对检索到的数据增加业务逻辑后进一步

发布成一个新的微服务，这符合DRY原则。另外，每个服务都有自己的缓存和数据库。如果聚合器是一个组合服务，那么它也有自己的缓存和数据库。聚合器可以沿X轴和Z轴独立扩展。

**2、代理微服务设计模式**



![img](https://pic3.zhimg.com/80/v2-20bc7429847c7670d7965837992afdde_1440w.webp)



在这种情况下，客户端并不聚合数据，但会根据业务需求的差别调用不同的微服务。代理可以仅仅委派请求，也可以进行数据转换工作。

**3、链式微服务设计模式**

这种模式在接收到请求后会产生一个经过合并的响应，如下图所示：



![img](https://pic3.zhimg.com/80/v2-8efdb51b81354c4e49e307eb6f3ada3e_1440w.webp)



在这种情况下，服务A接收到请求后会与服务B进行通信，类似地，服务B会同服务C进行通信。所有服务都使用同步消息传递。在整个链式调用完成之前，客户端会一直阻塞。

因此，服务调用链不宜过长，以免客户端长时间等待。

**4、分支微服务设计模式**

这种模式是聚合器模式的扩展，允许同时调用两个微服务链，如下图所示：



![img](https://pic3.zhimg.com/80/v2-abfadf45e0a1a8a0e820ae252502d312_1440w.webp)

5、**数据共享微服务设计模式**

自治是微服务的设计原则之一，就是说微服务是全栈式服务。但在重构现有的“单体应用（monolithic application）”时，SQL数据库反规范化可能会导致数据重复和不一致。

因此，在单体应用到微服务架构的过渡阶段，可以使用这种设计模式，如下图所示：



![img](https://pic2.zhimg.com/80/v2-e236e03da04bb47f864b711fd461130d_1440w.webp)

在这种情况下，部分微服务可能会共享缓存和数据库存储。不过，这只有在两个服务之间存在强耦合关系时才可以。对于基于微服务的新建应用程序而言，这是一种反模式。

**6、异步消息传递微服务设计模式**

虽然REST设计模式非常流行，但它是同步的，会造成阻塞。因此部分基于微服务的架构可能会选择使用消息队列代替REST请求/响应，如下图所示：

![img](https://pic3.zhimg.com/80/v2-92df10a937cb8090ffb6d0096f70b56e_1440w.webp)



#### 6、优点和缺点

优点：复杂度可控，独立按需扩展，技术选型灵活，容错，可用性高

```
不限制技术选择，开发人员可以自由选择任何有用的技术，只要该服务符合API合同。
Microservice架构模式使每个微服务都能独立部署。开发人员不需要协调部署本地服务的变更。这些变化可以在测试后尽快部署。例如，UI团队可以执行A | B测试，并快速迭代。
Microservice架构模式使每个服务都可以独立调整。您可以仅部署满足其容量和可用性限制的每个服务的实例数。此外，您可以使用最符合服务资源要求的硬件。
```



缺点：多服务运维难度，系统部署依赖，服务间通信成本，数据一致性，系统集成测试，重复工作，性能监控等

```
分布式系统而产生的复杂性。开发人员需要选择和实现基于消息传递或RPC的进程间通信机制。此外，他们还必须编写代码来处理部分故障。
测试微服务应用程序也更复杂。服务类似的测试类将需要启动该服务及其所依赖的任何服务。
微服务应用通常由大量服务组成。例如，每个服务将有多个运行时实例。更多的移动部件需要进行配置，部署，扩展和监控。
```



#### 7、参考

https://zhuanlan.zhihu.com/p/510957199?utm_id=0&eqid=deedfcfb00017602000000026468a858