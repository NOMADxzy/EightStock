## 计算机网络

#### 互联网的构成：

**网络边缘**:位于互联网边缘与互联网相连的计算机和其他设备,如桌面计算机、移动计算机、服务器、其他智能终端设备
**网络核心**:由互联端系统的分组交换设备和通信链路构成的网状网络（两大功能：①路由确定数据分组从源到目标所使用的路径（全局操作）②转发：路由器或交换机将接收到的数据分组转发出去（本地操作））

个域网（蓝牙）、局域网（wifi）、域域网（城市网络）、广域网（国家网络）

#### 数据的三种交换方式

- 电路交换（早期）：建立连接、交换数据、释放连接
- 报文交换：报文大小无限制，存储转发，时延高
- 分组交换（目前使用）：划分报文，分组转发，终端合并

```markdown
优点：
    ①  无需建立连接  
    ②  线路利用率高
    ③  简化了存储管理
    ④  加速传输
    ⑤  减少出错概率和重发数据量
缺点
	  ①  引起了转发时延
    ②  需要传输额外的信息量
    ③  对于数据报服务，存在失序，丢失或重复分组的问题；对于虚电路服务，存在呼叫建立、数据传输和虚电路释放三个过程。
```

```markdown
# 分组交换也有存储转发过程
路由器
	•	当一个数据包到达路由器时，路由器会先暂时存储这个数据包在其内存（缓冲区）中。
	•	路由器会查找路由表，确定该数据包的下一跳或出口接口。
	•	然后，路由器会将数据包转发到下一个网络节点。
交换机
	•	交换机工作在数据链路层，根据MAC地址进行帧的转发。
	•	交换机在接收到帧后，会先存储帧在内存中，然后查找其MAC地址表，确定将该帧发送到哪个端口。
	•	如果端口繁忙，交换机也会在缓冲区中短暂存储帧，直到端口空闲后再将其发送出去。
```

#### 网络模型

##### OSI 7层模型

![img](https://gitee.com/xu_zuyun/picgo/raw/master/img/67df7eca8ba486a7282bef74321e2722.png)

```markdown
应用层：使用应用程序通过网络服务。
表示层：表示层用于处理交互数据的表示方式，例如格式转换，数据的加密和解密，数据压缩和回复等功能
会话层：负责维护通信中两个结点之间的会话建立维护和断开，以及数据的交换
传输层：提供端到端之间的数据传输服务，实现对数据进行控制和操作的功能。
网络层：单位 分组，在数据链路层的基础之上，提供点到点之间的通信，提供路由功能，实现拥塞控制，网络互联等功能。
数据链路层：单位 帧，在物理层的基础之上，提供结点到结点之间的服务，采取差错控制和流量控制的方法实现网路互联
物理层：单位bit，利用传输介质为通信的网络节点之间的建立
```

```markdown
疑难：
## 会话层
网络文件服务（NFS）依赖会话层来控制文件传输的会话。
RTP中通过SSRC管理会话

## 表示层
文件传输中对文件进行编码和解码的过程（例如，MIME 编码用于电子邮件）。
数据压缩服务如 ZIP 或 RAR，在将文件通过网络传输前压缩数据，在接收后再解压。
```

##### TCP/IP 4层模型

```
物理层和数据链路层
网络层
传输层
应用层
```

![img](https://gitee.com/xu_zuyun/picgo/raw/master/img/c2b921fd2023201a457a2b07fe3e8e9a.jpeg)

![在这里插入图片描述](https://gitee.com/xu_zuyun/picgo/raw/master/img/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ2MTAxODY5,size_16,color_FFFFFF,t_70.png)

综合OSI和TCP/IP的优点，采用一种只有五层协议的体系结构，从低到高分别是：**应用层、运输层、网络层、数据链路层和物理层**。

![1036857-20161008144925254-1398507493](https://gitee.com/xu_zuyun/picgo/raw/master/img/f1c9fa297946e59f9e19262b4632e3d1.jpeg)

![在这里插入图片描述](https://gitee.com/xu_zuyun/picgo/raw/master/img/dd050edd429a44c58e07eddce143c45c.png)

#### 各层协议的主要负责人

**传输层**：传输层（如TCP、UDP）主要由操作系统的网络栈维护。操作系统负责管理数据流的可靠性、分段和重组、错误检测与重传、流量控制等功能。（操作系统向上层提供套接字。）

**网络层**：主要由操作系统处理。IP协议是网络层的核心，它由操作系统的网络栈来维护和执行。操作系统负责管理路由表、处理IP地址、分包、重组等功能。（所以称为TCP/IP协议栈）

**数据链路层：**核心功能由硬件网卡（NIC）维护，网卡负责帧的封装、解封装，MAC地址的处理，错误检测等。（通过中断通知操作系统协议栈）

**物理层：**网卡中的物理层芯片Wi-Fi天线等负责信号的发送和接收、调制和解调等低级物理传输工作。（通过帧开始标志 划分出一帧通知数据链路层）

### 一、物理层

- **中继器【Repeater，也叫放大器】**：同一局域网的再生信号；两端口的网段必须同一协议；5-4-3规程： 10BASE-5以太网中，最多串联4个中继器，5段中只能有3个连接主机；
- **集线器**：同一局域网的再生、放大信号（多端口的中继器）；半双工，不能隔离冲突域也不能隔离广播域。
- **网卡：**产生信号

![四台电脑和集线器.gif](https://gitee.com/xu_zuyun/picgo/raw/master/img/e40740b77da54d998a860747c0cc97f8~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp)

```
集线器 是特殊的 中继器
交换机 是特殊的网桥
```

#### 数据链路帧到物理信号

**1.帧到比特的转换**

**编码：**网卡将数据链路帧中的数据（通常以字节形式表示）转换为一系列的比特。这涉及到将字节数据转换为符合物理媒介要求的编码格式（例如曼彻斯特编码、NRZ编码等）。

**2.比特到电信号的转换**

**调制**：在无线网络中，网卡将比特数据调制成无线信号。调制是将数据比特转换成适合无线传输的电磁波信号的过程。有线网络中直接通过电信号传输。

```
**调制技术**：例如调频（FM）、调幅（AM）或相位调制（PSK）。
**电信号生成**：在有线网络中，网卡将比特数据转换成电信号。代表比特的高电平和低电平状态。
**电信号生成**：例如，通过调节电流强度或电压来表示比特的 0 和 1。
```

**3.物理信号的发送**

**发送信号**：网卡通过物理媒介（如网线或无线频谱）发送生成的电信号或无线信号。对于有线网络，这通常涉及通过以太网线缆传输电信号；对于无线网络，这涉及通过无线电波传输信号。

### 二、数据链路层

#### 结构

- **MAC层** 负责物理地址寻址和实际的数据帧传输，解决设备如何共享网络介质的问题，更多地与物理层打交道。
- **LLC层** 负责链路的逻辑控制、流量控制和差错检测等，更多地与网络层打交道。

#### 协议

**1. Ethernet：**家庭/办公网络，使用MAC地址

共享同一个通信介质（即网络电缆）来发送数据。这个共享的介质，类似于当时物理学家假想的“以太”，是所有设备都可以通过它传输和接收信号的无形媒介。

**2. PPP：**电话拨号接入，点对点通信

- **Address（地址字段）：** 该字段始终是一个固定的广播地址（0xFF），表示数据帧发送到链路的另一端。因为PPP是点对点通信，这个字段实际没有作用，它固定为广播地址。
- **Payload（信息字段）：** 这部分是实际传输的数据，比如IP数据包。
- **FCS（帧校验序列）：** 用于检测帧中的错误。

#### 冲突域、广播域

- 冲突域: 在同一个冲突域中的每一个节点都能收到所有被发送的帧，同一时间内只能有一台设备发送信息的范围
- 广播域: 网络中能接收任一设备发出的广播帧的所有设备的[集合](https://so.csdn.net/so/search?q=集合&spm=1001.2101.3001.7020)，如果站点发出一个广播信号，所有能接收收到这个信号的设备范围称为一个广播域

#### 网卡

工作在物理层和数据链路层，存在于路由器、交换机、终端设备中

##### 组成：

- **网络接口**：物理接口（如以太网端口（RJ-45）、光纤端口或无线天线）用于连接到网络介质；收发器用于将数字信号转换为电信号

- 发送缓存：存储准备好发送的数据帧

- 接收缓存：存储从网络中接收到的数据帧，后续通过中断通知CPU

  ```
  存在这种情况，网卡接受缓存满了，但是操作系统迟迟没有处理，导致发送方的新发送的帧无法被接收而丢失
  ```

- 固件：在网卡的非易失性存储器中，实现数据链路层协议的具体细节

- 驱动程序：集成到操作系统的网络栈中，网络栈将数据封装为数据帧，驱动程序负责将帧发送到物理介质上，或将接收到的帧传递给网络栈进行处理。

##### 职责：

1️⃣物理层

- 将内部的数字数据转换为有线网中的电信号或者无线网中的无线信号
- 将网络中的电信号或无线信号转换为数字信号放入网卡**接收缓存**中

2️⃣数据链路层

- 网卡在接入网络后，会监听网络上传输的数据帧。
- 数据链路层处理： 网卡在物理层接收比特流后，会将比特流重新组装为数据帧。
- 如果帧的目的MAC地址与网卡的MAC地址匹配（或是广播地址），网卡会接受该帧，触发中断，传递给操作系统的网络栈进行进一步处理。
- 如果帧的目的MAC地址不匹配，网卡通常会丢弃该帧。

#### WIFI和有线网络

1. 是否双工

   wifi是半双工（因为发送和接受数据都是共用一个无线信道）、有线网是全双工（因为采用了双绞线，发送和接受是两条线，将双绞线插入RJ45网口）

2. 多设备连接碰

   wifi通过CSMA/CA（因为接受数据时不能发送），而有线网通过CSMA/CD

3. wifi和有线网都是以太网，传输的都是MAC帧

#### 网桥

两个或多个以太网通过网桥连接后，就成为一个覆盖范围更大的以太网，而原来的每个以太网就称为一个[网段](https://so.csdn.net/so/search?q=网段&spm=1001.2101.3001.7020)，可以使以太网各网段成为隔离开的碰撞域，但不隔离广播域。

#### 交换机

```
MAC映射表
```

交换机中有一张MAC地址表（通过记录源地址生成），每个数据链路帧到达时 取出帧头中的目的MAC地址，查找到对应的接口，将其转发到该接口上，从而隔离了冲突域

![四台电脑和交换机之间数据传输.gif](https://gitee.com/xu_zuyun/picgo/raw/master/img/981d803ca6c240809e41a822c2b3c86a~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp)

本质上说，以太网交换机是一个多端口的网桥，它工作在数据链路层，交换机能经济地将网络分成小的冲突域，为每个工作站提供更高的带宽

```markdown
## 交换机的功能：
(1)存储-转发以太网帧
(2)检验到达帧的目的MAC地址， 选择性(selectively) 向一个或多个输出链路转发帧
(3)利用CSMA/CD访问链路，发送帧
## 交换机对于数据帧的处理动作：
	转发
	如果是单播数据帧，查询MAC地址表，根据MAC地址表执行转发动作。

	泛洪
	如果是单播数据帧，查询MAC地址表后无匹配项目，则执行泛洪动作。（即所有可泛洪端口都发送一份数据）如果是广播数据帧，则直接执行泛洪。其实是泛洪到所有对应的vlan下）组播数据帧看情况交换机会选择泛洪

	丢弃
	某个接口收到了数据帧，查表后需要从该接口发送，此时进行丢弃动作。
```

##### 差错检测：

1. 奇偶校验码–局限性：**当出错两位时，检测不到错误。**
2. 循环冗余检验码：根据传输或保存的数据**而产生固定位数校验码**。

##### 交换机的工作

交换机内部维护一张 **MAC 地址表**，记录着每一个 MAC 地址的设备，连接在其哪一个端口上。数据包到达交换机时，查找交换机内部的MAC地址表，发MAC地址对应端口

![img](https://gitee.com/xu_zuyun/picgo/raw/master/img/71b670de684c6a2ba5c0903afcdbc1d2.png)

#### 以太网协议

以太网规定：

- 一组电信号构成一个数据包，叫做"帧"（Frame）。
- 每一帧分成两个部分：标头（Head）和数据（Data）。
- 连入网络的所有设备，都必须具有"网卡"。发送端和接收端的地址便是指网卡的地址，即mac地址

![image-20231228215134826](https://gitee.com/xu_zuyun/picgo/raw/master/img/image-20231228215134826.png)

前6个十六进制数是厂商编号，后6个是该厂商的网卡流水号，MAC地址是独一无二的。

![img](https://gitee.com/xu_zuyun/picgo/raw/master/img/06765dad404a72429bead8950c219c10.png)

1. **类型**：标识上层协议（2字节）
2. **目的地址和源地址**：MAC地址（每个6字节）
3. **数据**：封装的上层协议的分组（46~1500字节）
4. **CRC**：循环冗余码（4字节）
5. **以太网最短帧**：以太网帧最短64字节；以太网帧除了数据部分18字节；数据最短46字节；

#### Wifi协议

WiFi 和以太网都是实现局域网（Local Area Network, LAN）的技术

- **WiFi**：是一种无线接入技术，可以提供移动性支持。
- **以太网**：通常指有线连接，需要使用网线进行数据传输。

```markdown
# wifi局域网内的两台设备之间传输数据也需要通过路由器AP

1. 所有设备通过路由器进行数据传输，可以使得路由器协调各个设备的发送时机，避免多个设备同时发送数据而引发碰撞。
2. 设备不具备全局的 MAC 地址表，无法知道目标设备的 MAC 地址在网络中的位置。
```

#### 冲突域与广播域

**冲突域：**同一介质上的多个节点共享链路的带宽，争用链路的使用权，这样就会产生信号冲突碎片现象，导致数据无法被转发。

**广播域：**在使用交换机互联的以太网中，同一区域内的主机在相互通信时可能会产生广播报文，此时广播报文会被交换机泛洪到整个区域内。

LAN的MAC层采用是CSMA/CD，WLAN的MAC层采用是CSMA/CA，所以LAN端口连接设备跟WLAN连接设备肯定不是一个冲突域。理论上WLAN不同信道确实是就不属于一个冲突域了，但802.11b/g/n无线局域网协议标准划分的信道有些是重叠的，当然可以选择1，6，11这三个信道它们不重叠，这主要是考虑跟其他家庭的WLAN冲突。另一个WLAN只能工作一个信道，所以接入同一个WLAN的设备都在同一个冲突域下面。

- 一台HUB就是一个冲突域、一台交换机的每个接口都是一个冲突域
- 路由器的一个端口就是一个广播域，VLAN技术可以隔离广播域

### 三、网络层

#### IP协议

![img](https://gitee.com/xu_zuyun/picgo/raw/master/img/c6046e124eae4233a8ef721e04ad4ae1.png)

- 位标识：这个标识号在发送端是唯一的，至少在短时间内不会重复。所有从同一个原始数据报分片出来的片段都会有相同的标识号。

- 位标志：（帮助更好的分片和重组）

  第一位：保留位

  第二位：不分片

  第三位：更多片

- 位偏移：该片段在原始数据报中的相对位置。它指示该片段的第一个字节相对于原始数据报的首位字节的偏移量（单位是8字节）

  ```
  为什么是8字节？
  1. 节省空间，如果是1字节，那13位只能支持4096个字节
  2. 32位字长的CPU处理4字节或8字节的数据块会更有效率
  ```

IP协议非常简单，**仅仅提供不可靠、无连接的传送服务**。IP协议的主要功能有：无连接数据报传输、数据报路由选择和差错控制。IP协议使得复杂的实际网络变为一个虚拟互联的网络；并且**解决了在虚拟网络中数据报传输路径的问题**。

- IP协议（Internet Protocol，因特网互联协议）;
- ICMP协议（Internet Control Message Protocol，因特网控制报文协议）;
- IGMP协议（主机向网络中的路由器报告它们希望接收或停止接收某个特定多播组的数据）
- ARP协议（Address Resolution Protocol，地址解析协议）;
- RARP协议（Reverse Address Resolution Protocol，逆地址解析协议）——逐渐被DHCP取代

![img](https://gitee.com/xu_zuyun/picgo/raw/master/img/81ecde62bf5383da3864b011575d436d.png)

#### 路由器

```
NAT表
路由表
ARP表
MAC映射表
```

##### 路由表

主机、路由器、网关都有自己的路由表

###### 主机路由表：

比较简单，通常只决定数据包是否发给网关、是否回环

```
default via 192.168.1.1 dev eth0
192.168.1.0/24 dev eth0 proto kernel scope link src 192.168.1.100
127.0.0.0/8 dev lo
```

###### 路由器路由表：

![image-20240911161715681](https://gitee.com/xu_zuyun/picgo/raw/master/img/202409111617906.png)

- 一个默认路由，将所有未明确指定目标的流量转发到外部网关 192.168.1.1。（由网关进行进一步的转发）
- 一个本地局域网 192.168.1.0/24 的路由，允许局域网设备之间的通信。
- 一个转发到远程子网 10.10.0.0/24 的路由，需要经过网关 192.168.1.2（另一个局域网）。
- 一个本地环回路由 127.0.0.0，不会将数据包转发到网络中，用于本地进程间通信。

这里局域网和广域网都是eth0，因为使用单个接口来处理局域网和广域网流量可以降低设计复杂度和成本。路由器内通过 NAT 技术和防火墙等功能实现局域网与广域网的逻辑隔离。

路由器收到一个IP数据包后，提取出目的IP地址，与路由表中的网络地址匹配（优先取最长网络地址），获取匹配项的网关地址，用ARP表查出网关对应的MAC地址，封装好数据帧利用网卡将其发送到该接口上（网络接口（如 eth0）负责通过某个物理网络进行通信）

###### 网关路由表：

| 目标网络    | 子网掩码      | 下一跳地址  | 接口 |
| ----------- | ------------- | ----------- | ---- |
| 192.168.1.0 | 255.255.255.0 | 0.0.0.0     | eth0 |
| 10.0.0.0    | 255.0.0.0     | 192.168.1.1 | eth0 |
| 172.16.0.0  | 255.240.0.0   | 192.168.1.1 | eth0 |
| 0.0.0.0     | 0.0.0.0       | 203.0.113.1 | eth0 |

最后一项为外网的网关

##### 接口

家用路由器包含一个WAN口和多个LAN口

- LAN口

  用于连接本地设备，形成局域网（Local Area Network）。比如连接电脑、交换机等。

  LAN口之间的设备通常可以相互通信，并共享路由器的WAN接口来访问外部网络。

  WLAN（**Wireless Local Area Network**）是指 **无线局域网**

  家用路由器集成了交换机的功能（利用这些LAN口）

  发往LAN内部网络的数据包通过LAN接口发送（如 eth0）。

- WAN口

  WAN口通常连接到调制解调器（例如光猫或ADSL猫），负责通过互联网与外部服务器进行通信。

  通过PPPoe(Point-to-Point Protocol over Ethernet)与ISP网络进行用户认证、IP分配和数据传输

  发往外部网络的数据包通过WAN接口发送（如 eth1 或 ppp0）。

##### NAT

- 当局域网中的设备（通常使用私有IP地址，如192.168.x.x）发出请求时，家用路由器通过NAT表将这些私有IP地址转换为路由器的“公共”IP地址。

  现在路由器的IP地址也是 **私网IP地址**，通常在 100.64.0.0/10 段，运营商级别的NAT

- 返回的数据包会通过NAT表还原成私有IP，并发送回正确的局域网设备。

##### IP地址

- 路由器通常有**两个或多个IP地址**，分别用于局域网（LAN）和广域网（WAN）。
- **路由器的LAN IP地址**和**默认网关的IP地址**是一样的

##### 网关

连接本地局域网（LAN）和外部互联网，路由器在局域网中扮演的是**默认网关**的角色，负责转发局域网中的设备发送到互联网的数据包。网关收到数据包后，查找路由表，通过WAN接口发送到ISP。

网关也有自己的路由表，网关的路由表通常包含与外部网络相关的路由信息，负责内外网之间的连接。（家庭路由器的网关和路由器是合二为一的，路由表也是同一个）

##### 过程

 1. **路由表查询**

    **第一次路由表查询**：主机检查自身的路由表，决定数据包发送给网关。

    **第二次路由表查询**：路由器接收数据包后，检查其路由表并将数据包转发到局域网。

    **第三次路由表查询**：网关接收数据包后，检查其路由表并将数据包转发到广域网。

 2. **路由器网关解封装**：网关收到以太网帧后，解析出其中的IP数据包，并查看目标IP地址。

	1. **转发到广域网**：查找其路由表，决定将数据包从其WAN口转发到ISP网络。可能使用NAT（网络地址转换）技术，将设备的私有IP地址转换为分配的公共IP地址。NAT后，路由器网关会重新封装数据包：

- **目标IP地址**：依然是目的主机的公共IP地址（如 8.8.8.8）。
- **源IP地址**：被NAT转换后的公共IP地址（如 123.456.789.101）。
- 封装进广域网链路协议帧（如PPP或更高层次的封装）。

​	3.	**广域网中的传输**：封装好的数据包从路由器的WAN口发出，通过ISP的网络设备传输，最终到达目的IP所在的服务器或设备。

![img](https://gitee.com/xu_zuyun/picgo/raw/master/img/2bd5889c711d50892afcc21a2647af22.png)

#### ISP骨干网络

- 接入层：用户端的光猫，进行身份认证和建立连接
- 汇聚层：高性能路由器和汇聚交换机，汇聚来自接入层的流量
- 核心层：核心路由器和高速交换机，负责网络中数据包转发和高效路由（OSPF、RIP）
- 骨干层：高速光纤传输设备，ISP内部的长距离流量和连接不同区域的网络节点，是ISP网络的骨架

#### 五类IP地址

互联网诞生之初，IP 地址显得很充裕，于是计算机科学家们设计了**分类地址**。

| 类别 | 范围                        | 最大主机数 |
| ---- | --------------------------- | ---------- |
| A    | 0.0.0.0 - 127.255.255.255   |            |
| B    | 128.0.0.0 - 191.255.255.255 |            |
| C    | 192.0.0.0 - 223.255.255.255 |            |
| D    | 224.0.0.0 - 239.255.255.255 |            |
| E    | 240.0.0.0 - 255.255.255     |            |

##### A、B、C 类

主要分为两个部分，分别是**网络号和主机号**。

每个网段下，两个 IP 是特殊的，分别是主机号全为 1 和 全为 0 地址。

- 主机号全为 1 指定某个网络下的所有主机，用于广播
- 主机号全为 0 指定某个网络

##### C、D类

D 类常被用于**多播**，E 类是预留的分类，暂时未使用。

共同点：其前四位是 `1110`

- 224.0.0.0 ~ 224.0.0.255 为预留的组播地址，只能在局域网中，路由器是不会进行转发的。
- 224.0.1.0 ~ 238.255.255.255  为用户可用的组播地址，可以用于 Internet 上。
- 239.0.0.0 ~ 239.255.255.255 为本地管理组播地址，可供内部网在内部使用，仅在特定的本地范围内有效。

#### IP分片

![26](https://gitee.com/xu_zuyun/picgo/raw/master/img/26.webp)

在分片传输中，一旦某个分片丢失，则会造成整个 IP 数据报作废，所以 TCP 引入了 `MSS` 也就是在 TCP 层进行分片不由 IP 层分片，那么对于 UDP 我们尽量不要发送一个大于 `MTU` 的数据报文。

#### MTU

更大的MTU可以减少每个数据包的头部开销，从而提高数据传输效率，但同时也可能导致传输延迟增加。

- Ethernet 头部（14 字节） + IPv4 头部（20 字节） + TCP 头部（20 字节） = 54 字节的头部开销。
- 最初规定的帧大小为最小64字节和最大1518字节（其中包括以太网头部和CRC）。在这个范围内，1500字节的MTU设定被选为可行的一个标准值，以便在网络中传输数据。
- **兼容性**：1500字节的MTU得到了广泛的支持，各种网络设备和协议之间的兼容性较好，减少了配置和管理复杂性。1500字节的MTU能够很好地满足大多数应用的需求

```markdown
## 64字节的由来
以太网使用的是载波监听多路访问/冲突检测（CSMA/CD）协议。在网络中，数据帧从发送到接收的时间必须足够长，以便在发生碰撞时，发送方能够检测到碰撞并采取适当的行动。
```

#### IPv6

1. **取消了首部校验和字段。** 因为在数据链路层和传输层都会校验，因此 IPv6 直接取消了 IP 的校验。
2. **取消了分片/重新组装相关字段。** 分片与重组是耗时的过程，IPv6 不允许在中间路由器进行分片与重组，这种操作只能在源与目标主机，这将大大提高了路由器转发的速度。
3. **取消选项字段。**

![31](https://gitee.com/xu_zuyun/picgo/raw/master/img/31.webp)

如何使IPv4设备和IPv6设备进行通信？

1. **双栈（Dual Stack）**：在同一设备上同时支持IPv4和IPv6。这样的设备有两个IP地址，可以与IPv4或IPv6网络通信。
2. **隧道技术（Tunneling）**：将IPv6数据包封装在IPv4数据包中，以便它们可以通过IPv4基础设施传输。常见的隧道技术包括 6to4、6in4、ISATAP 等。
3. **协议转换（Protocol Translation）**：例如NAT64，它允许IPv6设备通过转换网关访问IPv4服务。

#### NAT技术

1. 出数据报：外出数据报用 NAT IP地址(全局), 新port # 替代 源IP地址(私有), port #

2. NAT转换表：每个 (源IP地址, port #)到(NAT IP地址, 新port #) 映射项

3. 入数据报：对每个入数据报的地址字段用存储在NAT表中的(源IP地址, port #)替代对应的 (NAT IP地址, 新port #)

4. NAT根据不同的IP上层协议进行NAT表项管理

5. 传输层TCP/UDP拥有16-bit 端口号字段，所以一个WAN侧地址可支持60,000个并行连接

![在这里插入图片描述](https://gitee.com/xu_zuyun/picgo/raw/master/img/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ2MTAxODY5,size_16,color_FFFFFF,t_70-20231228222957000.png)

#### 路由选择

1. 静态路由

2. 动态路由：RIP，OSPF，BGP

   ![img](https://gitee.com/xu_zuyun/picgo/raw/master/img/v2-a7610f1b4f5405773651b755b80e9018_1440w.png)

   当路由器收到一个IP数据包时，路由器会解析出IP数据包中的目的IP地址，然后根据目的IP地址查找路由表，依据**最长掩码匹配**原则，找到对应的路由条目。

1. 自治区域内部：内部网关协议 IGP (Interior Gateway Protocol)
2. RIP (Routing Information Protocol)：距离矢量协议，使用“跳数”来衡量到达目标地址的路由距离，有 15 跳的限制，所以只适用于小区域，**RIP 用 UDP 数据报传送**
3. OSPF (Open Shortest Path First)：链路状态协议，使用“带宽”、“延迟”作为度量标准，使用 Dijkstra 算法找最短路径，**OSPF 直接用 IP 数据报传送**
4. 自治区域外部：外部网关协议 EGP (External Gateway Protocol)
5. BGP (Border Gateway Protocol)：边界网关路由协议是一种用于自治系统之间的外部网关协议。其功能是同其他的BGP系统交换网络可达信息，实现自治系统间无环路的路由信息交换。BGP的最新版本是BGP版本4(BGP-4)，它支持无类域间路由(CIDR)并使用路由聚合机制减小路由表的尺寸。在路由协议中，**只有BGP使用TCP作为传输层协议**

#### 网关

网关实质上是一个网络通向其他网络的IP地址，网关在网段内的可用**ip中选一个**，不过，一般用的是**第1个和最后一个**。

在没有**路由器**的情况下，不同的两个网络之间是**不能**进行TCP/IP通信的。

当设备连接到网络时，会向网络中的DHCP服务器发送请求，DHCP服务器会返回包含IP地址、子网掩码、默认网关、DNS服务器等信息的响应。

当一台计算机发送信息时，根据发送信息的目标地址，通过[子网掩码](https://baike.baidu.com/item/子网掩码/100207?fromModule=lemma_inlink)来判定目标主机是否在本地子网中，如果目标主机在本地子网中，则直接发送即可。如果目标不在本地子网中则将该信息送到缺省网关/路由器，由路由器将其转发到其他网络中，进一步寻找目标主机。

#### ARP协议

![image-20240911114410074](https://gitee.com/xu_zuyun/picgo/raw/master/img/202409111144795.png)

ARP 位于 **数据链路层和网络层之间**，通过数据链路帧封装了ARP包

无论是电脑、手机、移动终端还是三层网络交换机（路由器）都有一张ARP表。

ARP是网络基础机制，大多数设备都内置ARP处理程序

ARP协议交互过程就两个包，广播问答包，单播回答包。

```markdown
# 发送方过程
发送方想给目标IP发送数据，发现ARP缓存中没有对应的MAC地址
封装ARP请求为数据链路帧，将目标地址置为FFFFFF
发送到局域网络中
...
收到ARP响应，将其中的发送方IP和MAC地址添加到ARP缓存中

# 接收方过程
设备首先在数据链路层接收到一个广播以太网帧，发现类型是ARP数据包
判断目标IP地址是否是本机IP，发现是本机IP
通过操作系统或网络接口层轻松查找到自己的MAC地址
封装ARP响应（利用ARP请求中的地址和本机的MAC地址）
```

```markdown
# CPU的角度

网卡持续监听以太网，接收到数据帧后，会将其放入网卡的接收缓冲区，并触发硬件中断，通知操作系统有新的网络数据需要处理。
中断处理程序，将数据从网卡缓冲区移到系统内存中，通知操作系统网络栈
网络栈会分析收到的数据帧的类型，将其交给ARP处理模块

ps —— 通过中断合并技术，网卡会积累多个数据帧再触发中断
```

![image-20240911115730225](https://gitee.com/xu_zuyun/picgo/raw/master/img/202409111157454.png)

```markdown
## 主机向另一个网段传输一段数据的具体过程
    A创建IP数据包（源为A、目的为E）
    在源主机A的路由表中找到路由器R的IP地址223.1.1.4
    A根据R的IP地址223.1.1.4，使用ARP协议获得R的MAC地址
    A创建数据帧（目的地址为R的MAC地址）
    数据帧中封装A到E的IP数据包
    A发送数据帧，R接收数据帧
```

![同一子网数据传输之路由器.gif](https://gitee.com/xu_zuyun/picgo/raw/master/img/73e83a1170454dc6acac81aafc8a90cd~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp)

![不同子网数据传输之路由器-压缩.gif](https://gitee.com/xu_zuyun/picgo/raw/master/img/f5cdbdf810d64420a01d51710e3668c4~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp)

#### RARP协议（弃用）

- 早期网络中没有本地硬盘，因此也没有保存 IP 地址的能力
- 它只能通过 MAC 地址请求 IP 地址，无法提供其他网络配置信息，而且 RARP 需要在每个网络中部署专门的 RARP 服务器。

#### DHCP协议

- 客户端首先发起 **DHCP 发现报文（DHCP DISCOVER）** 的 IP 数据报，由于客户端没有 IP 地址，也不知道 DHCP 服务器的地址，所以使用的是 UDP **广播**通信，其使用的广播目的地址是 255.255.255.255（端口 67） 并且使用 0.0.0.0（端口 68） 作为源 IP 地址。DHCP 客户端将该 IP 数据报传递给链路层，链路层然后将帧广播到所有的网络中设备。
- DHCP 服务器收到 DHCP 发现报文时，用 **DHCP 提供报文（DHCP OFFER）** 向客户端做出响应。该报文仍然使用 IP 广播地址 255.255.255.255，该报文信息携带服务器提供可租约的 IP 地址、子网掩码、默认网关、DNS 服务器以及 **IP 地址租用期**。
- 客户端收到一个或多个服务器的 DHCP 提供报文后，从中选择一个服务器，并向选中的服务器发送 **DHCP 请求报文（DHCP REQUEST**进行响应，回显配置的参数。
- 最后，服务端用 **DHCP ACK 报文**对 DHCP 请求报文进行响应，应答所要求的参数。

DHCP 交互中，**全程都是使用 UDP 广播通信**。

由于广播包不能跨网段，通过以下方式实现一个DHCP服务器控制多个网段：

- DHCP 客户端会向 DHCP 中继代理发送 DHCP 请求包，而 DHCP 中继代理在收到这个广播包以后，再以**单播**的形式发给 DHCP 服务器。
- 服务器端收到该包以后再向 DHCP 中继代理返回应答，并由 DHCP 中继代理将此包广播给 DHCP 客户端 。

```markdown
## DHCP服务是部署在哪里？
一、家庭网络中，路由器会集成DHCP服务
二、大型企业会有单独的DHCP服务器 集中管理IP地址的分配和子网掩码等参数
```

#### ICMP协议

- ICMP 消息实际上是作为 IP 数据包的负载被发送的。
- 当 IP 数据包在网络中传输时遇到问题（如路由失败、TTL 递减至零、数据包碎片化失败等），网络设备（如路由器）使用 ICMP 来向原始发送者提供发生问题的反馈。
- ICMP可以提供网络状态信息，从而`间接`地影响到实现拥塞控制的上层协议。

![在这里插入图片描述](https://gitee.com/xu_zuyun/picgo/raw/master/img/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ2MTAxODY5,size_16,color_FFFFFF,t_70-20231228223131926.png)

差错报告：目的端不可达、源端抑制（如果一台高速计算机向远程计算机发送大量数据，可能会使路由器产生过载。这时路由器可以利用ICMP，让它降低发送数据的速度。）、超时、参数问题。

```markdown
## 特点：
ICMP 不能纠正差错; 它只是报告差错。差错纠正留给高层协议去做。
差错报文总是发送给原始的数据源，因为在数据报中关于路由惟一可用的信息就是源 IP 地址和目的 IP 地址。

## 一些要点:
1.对于携带 ICMP 差错报文的数据报，不再产生 ICMP差错报文。
2.对于分段数据报，如果不是第一个分段，则不产生ICMP 差错报文。
3.对于具有多播地址的数据报，不产生 ICMP 差错报文。
4.对于有特殊地址(如 127.0.0.0或0.0.0.0)的数据报，不产生 ICMP 差错报文。
```

```markdown
## Ping
主要用来测试两台主机之间的连通性。
Ping 的原理是通过向目的主机发送 ICMP Echo(`回显`)请求报文，目的主机收到之后会发送 Echo 回答报文。Ping 会根据时间和成功响应的次数估算出`数据包往返时间以及丢包率`。

## Traceroute
Traceroute 发送的 IP 数据报封装的是无法交付的 UDP 用户数据报，并由目的主机发送终点不可达差错报告报文。

    源主机向目的主机发送一连串的 IP 数据报。第一个数据报 P1 的生存时间 TTL 设置为 1，
    源主机接着发送第二个数据报 P2，并把 TTL 设置为 2...
    不断执行这样的步骤，直到最后一个数据报刚刚到达目的主机，主机不转发数据报，也不把 TTL 值减 1。但是因为数据报封装的是无法交付的 UDP，因此目的主机要向源主机发送 ICMP 终点不可达差错报告报文。
    之后源主机知道了到达目的主机所经过的路由器 IP 地址以及到达每个路由器的往返时间。
```

#### IGMP网际组管理协议   

- 适用于管理协议多播组成员的一种通信协议。IP主机和相邻路由器利用IGMP来创建多播组的组成员。组播方式解决了单播情况下数据的重复拷贝及带宽的重复占用，也解决了广播方式下带宽资源的浪费

### 四、传输层

传输层负责将上层数据分段并提供端到端的、可靠的或不可靠的传输。此外，传输层还要处理**端到端**的差错控制和流量控制问题。

```markdown
不可靠传输信道在数据传输中可能发生的情况：比特差错、乱序、重传、丢失
基于不可靠信道实现可靠数据传输采取的措施：

    差错检测：利用编码实现数据包传输过程中的比特差错检测
    确认：接收方向发送方反馈接收状态
    重传：发送方重新发送接收方没有正确接收的数据
    序号：确保数据按序提交
    计时器：解决数据丢失问题；
```

#### UDP和TCP

![img](https://gitee.com/xu_zuyun/picgo/raw/master/img/377adab44aed2e73d34417ad0d2d2b8786d6fabf.jpeg)

##### 为什么需要三次握手？

1. **第一次握手**：客户发送请求，此时服务器知道客户能发；
2. **第二次握手**：服务器发送确认，此时客户知道服务器能发能收；
3. **第三次握手**：客户发送确认，此时服务器知道客户能收。

![在这里插入图片描述](https://gitee.com/xu_zuyun/picgo/raw/master/img/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ2MTAxODY5,size_16,color_FFFFFF,t_70-20231228224041160.png)

![在这里插入图片描述](https://gitee.com/xu_zuyun/picgo/raw/master/img/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ2MTAxODY5,size_16,color_FFFFFF,t_70-20231228224126309.png)

#### 单播和组播

- **单播 (Unicast)**: 单播传输是指在网络中一对一的通信。每个用户连接到直播服务器时，服务器都会与其建立一个独立的连接。互联网上的大多数直播服务，如YouTube Live、Twitch等，因为其可扩展性和跨不同网络环境的兼容性，主要采用单播。
- **组播 (Multicast)**: 组播传输允许单个发送者将数据同时发送给多个接收者（即一对多）。这种方式在受控的网络环境，如企业内部网络或特定的ISP网络中比较常见，因为它可以降低带宽的使用。但是，在公共互联网上由于路由器和防火墙的限制及缺乏普遍的支持，组播并不常用。

#### 流媒体直播

业界直播系统的选择在单播和组播、UDP和TCP之间，取决于应用场景、性能需求以及用户的网络条件

- 如果直播场景对延迟要求极高（例如实时交互或游戏直播），可能更倾向于使用基于UDP的协议，如WebRTC或者 RTMP（虽然RTMP可以运行在TCP之上，但其设计目标是减少延迟）。
- 如果直播场景更注重内容的可靠传输和质量（如商业活动直播），那么基于TCP的协议（HLS、DASH）可能会更加合适，因为它们提供了自适应比特率流媒体技术，以及更好的错误恢复机制。

#### 常用端口号

| 端口号 | 服务   | 作用                                                     |
| ------ | ------ | -------------------------------------------------------- |
| 21     | FTP    | 文件传输协议，用于在客户端和服务器之间传输文件。         |
| 22     | SSH    | 安全外壳协议，用于在网络中安全地远程登录和执行命令。     |
| 23     | TELNET | 用于远程登录到远程主机并执行命令。                       |
| 25     | SMTP   | 简单邮件传输协议，用于发送电子邮件。                     |
| 53     | DNS    | 域名解析                                                 |
| 80     | HTTP   | 超文本传输协议，用于在Web浏览器和Web服务器之间传输数据。 |
| 110    | POP3   | 邮局协议版本3，用于从邮件服务器接收电子邮件。            |
| 443    | HTTPS  | 安全超文本传输协议，通过加密通信保护Web数据传输。        |

```
TELNET和SSH的区别？
安全性：TELNET 传输的数据（包括密码和其他敏感信息）以明文形式发送，没有任何加密措施。这使得 TELNET 非常容易受到中间人攻击和窃听。
历史：是早期互联网上最流行的远程登录协议之一，但由于其缺乏安全性，在现代网络中已经被几乎完全淘汰。

SSH 在数据传输过程中提供了强大的加密，可以保护数据免受窃听和中间人攻击。
SSH 还允许文件传输，如通过 SFTP 或 SCP 协议。
```

```
POP3和SMTP？
POP3是一个邮件获取协议，当使用 POP3 时，通常邮件会被下载并从服务器上删除，尽管现代邮件客户端允许你选择保留服务器上的副本。但此协议设计时没有考虑多设备之间的同步。

SMTP 是一个邮件发送协议，用于将邮件从一个邮件客户端发送到邮件服务器或从一个邮件服务器传递到另一个邮件服务器。
可以使用587端口（对于客户端到服务器的邮件提交建议使用，支持 STARTTLS 加密）
```

发送邮件的流程：

1. **编写邮件**：
   - 用户在邮件客户端（MUA，Mail User Agent）中撰写一封电子邮件。这个客户端可以是 Outlook、Thunderbird、Apple Mail，或是 webmail 服务如 Gmail。
2. **提交给服务器**：
   - 用户点击“发送”，邮件被提交到配置好的 SMTP 服务器。
   - 邮件客户端通常通过 SMTP（Simple Mail Transfer Protocol）与邮件服务器通信，并可能使用端口25、587（支持 STARTTLS）或465（SMTPS）进行加密连接。
3. **传递处理**：
   - 邮件服务器（MTA，Mail Transfer Agent）接收邮件，并且负责找到收件人的邮件服务器地址。
   - 可能会经过多个邮件服务器（MTAs）来路由邮件至目标。
4. **到达目标服务器**：
   - 邮件最终到达收件人域的邮件服务器，并存储在那里，等待收件人检索。

#### 套接字

设想在应用程序和网络之间存在一扇“门”：

    需要发送报文时：发送进程将报文推到门外
    门外的运输设施（因特网）将报文送到接收进程的门口
    需要接收报文时：接收进程打开门，即可收到报文

在TCP/IP网络中，这扇“门”称为套接字（socket），是应用层和传输层的接口，也是应用程序和网络之间的API

#### VPN

- VPN指利用公用网络架设专用网络的远程访问技术
- VPN通过隧道技术在公共网络上模拟出一条点到点的逻辑专线，从而达到安全数据传输的目的

![在这里插入图片描述](https://gitee.com/xu_zuyun/picgo/raw/master/img/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ2MTAxODY5,size_16,color_FFFFFF,t_70-20231228223745144.png)

### 五、应用层

为操作系统或网络应用程序提供访问网络服务的接口

1. 数据传输基本单位为报文；
2. 包含的主要协议：FTP（文件传送协议）、Telnet（远程登录协议）、DNS（域名解析协议）、SMTP（邮件传送协议），POP3协议（邮局协议），HTTP协议（Hyper Text Transfer Protocol）。

#### DNS协议

##### 查询过程

【1】浏览器缓存，【2】找本机的hosts文件，【3】路由缓存，【4】找DNS服务器（本地域名、顶级域名、根域名）->迭代解析、递归查询。
![image-20210825130407844](https://gitee.com/xu_zuyun/picgo/raw/master/img/55345eaf75c7aecad38bf2cbcd652a2f.png)

##### 协议字段

DNS 协议的头部由以下几部分组成，每部分的长度固定，共计 12 字节：

- **标识字段（Identification Field）**：2 字节
- 用于标识 DNS 查询和响应的唯一 ID，帮助客户端将响应与请求对应起来。
- **标志字段（Flags Field）**：2 字节
- 包含多个标志位，用于控制查询和响应的行为，包括 QR（0表示Q，1表示R）、Opcode、AA、TC、RD、RA、Z、Rcode 等。

##### 基于UDP

- ​	**默认情况**：UDP 协议进行传输，默认端口为 **53**。
- ​	**原因**：UDP 是一种无连接的协议，传输效率高，适合快速的请求-响应场景。大多数 DNS 查询和响应的数据量较小（小于 512 字节）。由于 UDP 不需要建立连接，通信开销较小，速度更快，非常适合 DNS 这种高频率、短消息的通信需求。
- 当数据超过512字节时，服务器和客户端会自动切换到TCP协议中传输

#### DHCP协议

DHCP（Dynamic Configuration Protocol:动态主机设置协议）：**是一个局域网协议，是应用UDP协议的应用层协议。** **作用：为临时接入局域网的用户自动分配IP地址。**

![在这里插入图片描述](https://gitee.com/xu_zuyun/picgo/raw/master/img/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ2MTAxODY5,size_16,color_FFFFFF,t_70-20231228222405705.png)

DHCP 客户从UDP端口68以广播形式向服务器发送发现报文（DHCPDISCOVER）
DHCP 服务器广播发出提供报文（DHCPOFFER）
DHCP 客户从多个DHCP服务器中选择一个，并向其以广播形式发送DHCP请求报文（DHCPREQUEST）
被选择的DHCP服务器广播发送确认报文（DHCPACK）

#### HTTP协议

1. **GET**：请求指定的页面信息，并返回实体主体；
2. **POST**：向指定资源提交数据进行处理请求；
3. **DELETE**：请求服务器删除指定的页面；
4. **HEAD**：请求读取URL标识的信息的首部，**只**返回报文头；
5. **OPETION**：请求一些选项的信息；
6. **PUT**：在指明的URL下存储一个文档。

#### WebSocket协议

通信流程

1. tcp3次握手建立连接
   SYN，SYN+ACK，ACK。

2. 用http协议进行2次握手

   ```http
   GET /chat HTTP/1.1
   Host: server.example.com
   Upgrade: websocket
   Connection: Upgrade
   Sec-WebSocket-Key: x3JJHMbDL1EzLkh9GBhXDw==
   Sec-WebSocket-Protocol: chat, superchat
   Sec-WebSocket-Version: 13
   Origin: http://example.com
   ```

   ​    第一次握手：客户端往服务端发送一个http报文，方法必须是GET，请求头中必须加上至少4个请求头，其中2个是：Connection: Upgrade和Upgrade: websocket。告诉服务端：我不想用当前的http协议，它只是我的棋子，我要升级协议，升级到websocket协议。
   ​    第二次握手：服务端接收到第一次握手报文后，如果自身支持且愿意升级到websocket协议和客户端通信，那么就响应一个http报文，状态码必须是101，同时也必须在响应头中3个响应头，其中2个是Connection: Upgrade和Upgrade: websocket，101状态码就是给升级协议用的。

3. 用websocket协议通信

   ```http
   HTTP/1.1 101 Switching Protocols
   Upgrade: websocket
   Connection: Upgrade
   Sec-WebSocket-Accept: HSmrc0sMlYUkAGmm5OPpG2HaGWk=
   Sec-WebSocket-Protocol: chat
   ```

   websocket报文结构和大多数的协议报文结构类似，分为报文头和报文载荷。http报文头都是用ASCII码来说明意思，websocket报文头用二进制来表达意思，所以websocket协议比http报文要省带宽

   数据帧和消息

   - **数据帧**：WebSocket数据传输基于帧，其中每个帧都包含帧开始和结束的标志。帧可以包含控制信息或数据载荷。对于大消息，它可以被分成多个帧顺序发送，在最后一个帧被标记为该消息的结束。
   - **消息**：一条消息由一个或多个帧组成。当所有组成消息的帧都到达时，消息被重新组装并交付给应用程序。

4. 用websocket协议进行2次挥手
   通信双方任意一方任意时刻都可以主动结束websocket通信，一方发送一个websocket协议报文，对方接到后，也会干脆的回一个挥手报文，此后只剩下一个裸的tcp连接在空中凌乱。

5. tcp4次挥手拆除连接
   此tcp连接的使命完成了，服务端率先拆除tcp连接(理论上谁都可以主动拆除连接)。无非是FIN，ACK，FIN，ACK。

##### webSocket和Socket的区别

```markdown
## socket
Socket是应用层与TCP/IP协议族通信的中间软件抽象层，它是一组接口（不是协议，为了方便使用TCP或UDP而抽象出来的一层，是位于应用层和传输控制层之间的一组接口）。是一个门面模式，它把复杂的TCP/IP协议族隐藏在Socket接口后面

## websocket
WebSocket 是一种在单个 TCP 连接上进行全双工通信的协议。WebSocket 使得客户端和服务器之间的数据交换变得更加简单，允许服务端主动向客户端推送数据。
t适合需要实时功能的应用，如在线游戏、实时交流、实时数据监控等。与HTTP轮询或长轮询相比，WebSocket提供了更低的延迟和更高效的网络利用率。
```

- Socket是传输控制层协议，WebSocket是应用层协议。
- WebSocket 更易用，而 Socket 更灵活，用户可以通过 Socket 来操作底层 TCP/IP 协议族通信。

![img](https://img-blog.csdnimg.cn/img_convert/bb3505691e77e64a08b52e7d6906e202.webp?x-oss-process=image/format,png)

### 参考文献

https://zhuanlan.zhihu.com/p/567092899?utm_id=0