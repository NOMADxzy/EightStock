## 一、quic数据包

![quic包结构](https://pic2.zhimg.com/80/v2-60231adb6c7014c7f043712839f77ab5_1440w.webp)

![quic包结构](https://pic2.zhimg.com/80/v2-f1cb88ac186e851a724a85dbd4f3de01_1440w.webp)

## 二、QUIC安全

不同于TCP+TLS的组合，QUIC把TLS功能直接嵌入到协议中。实现1-RTT甚至0-RTT的握手：

- **1-RTT握手**：对于首次连接，QUIC能够在一个往返内完成TLS握手和连接的建立。
- **0-RTT握手**：对于之前已建立过连接的客户端和服务器，QUIC可以利用预共享密钥（Pre-Shared Key，PSK）技术，允许客户端在握手时与第一个数据包一起发送加密的应用数据，从而消除了握手延迟。

### 普通的TCP + TLS

<img src="https://pic2.zhimg.com/80/v2-1fb94488942494ec9425ecf6682ed6e1_1440w.webp" width="280" ><img src="https://pic4.zhimg.com/80/v2-86cc5e2cf1b509083759b9c22800e2a7_1440w.webp" width="270" >

（1）客户端：生成随机数 a，选择公开的大数 G 和 P，计算 A=a*G%P，将 A 和 G 发送给服务器，也就是 Client Hello 消息

（2）服务器：生成随机数 b，计算 B=b*G%P，将 B 发送给客户端，也就是 Server Hello 消息

（3）客户端：使用 ECDH 算法生成通信密钥 KEY = a*B = a*b*G%P

（4）服务器：使用 ECDH 算法生成通信密钥 KEY = b*A = b*a*G%P

### QUIC的连接

![quic握手](https://pic2.zhimg.com/80/v2-d5e6bf3b74ae07927b0d62bccfa3c095_1440w.webp)

1RTT： 完成 初始密钥的交换 和 会话密钥的传递

（1）客户端：生成随机数 a，选择公开的大数 G 和 P，计算 A=a*G%P，将 A 和 G 发送给服务器，也就是 Client Hello 消息

（2）客户端：客户端直接使用缓存的 ServerConfig 计算初始密钥 initKey = a*B = a*b*G%P，加密发送应用数据 1

（3）服务器：根据 Client Hello 消息计算初始密钥 initKey = b*A = b*a*G%P

（4）服务器：生成随机数 c，计算 C=c*G%P，使用 initKey 加密 C，发送给客户端，也就是 Server Hello 消息

（5）客户端：使用 initKey 解码获取 C，计算会话密钥 sessionKey = a*C = a*c*G%P，加密发送应用数据 2

（6）服务器：计算会话密钥 sessionKey = c*A = c*a*G%P，解密获取应用数据 2

客户端缓存的 ServerConfig 是服务器静态配置的，是可以长期使用的。客户端通过 ServerConfig 实现 0-RTT 握手，使用会话密钥 sessionKey 保证通信数据的前向安全。

0RTT：使用之前存储的会话票据和相关的密钥信息来构建0-RTT握手的消息

服务器收到后：

接受：

**限制用途**——QUIC 明确建议只在知道重放攻击无法造成危害的情况下使用 0-RTT 数据。例如，GET 请求通常是安全的，因为它们是幂等的操作。

**切换**——即便是在处理0-RTT数据的同时，客户端和服务器也会启动一个正常的1-RTT握手过程，以便建立最新的加密参数，确保随后通信的前向安全。一旦1-RTT握手完成，客户端和服务器就会切换到新的、具有前向保密性的会话密钥，并继续进行加密通信。

不接受：

要求进行正常的完整握手

[详细前往](https://blog.csdn.net/qq_34629352/article/details/123864723)

## 三、QUIC可靠性

![quic重传](https://pic1.zhimg.com/80/v2-e6abef5bc9316fd87905a5e97b547050_1440w.webp)

通过包号（PKN）和确认应答（SACK）保证**数据完整**

通过数据偏移量 offset保证**数据有序**

## 四、QUIC流量控制

滑动窗口机制

![滑动窗口](https://pic4.zhimg.com/80/v2-62c627de56caf4617f97628215c4fa03_1440w.webp)

QUIC 的滑动窗口分为 Connection 和 Stream 两种级别。Connection 流量控制：规定了所有数据流的总窗口大小；Stream 流量控制：规定了每个流的窗口大小。

![流窗口](https://pic3.zhimg.com/80/v2-a5f95afac0935ae11f4672d3fdf9bf3e_1440w.webp)

**常用算法：**

New Reno：基于丢包检测

CUBIC：基于丢包检测

BBR：基于网络带宽

## 五、QUIC多路复用

**Http1.1:**单个连接 1 次只能发送 1 个请求的性能瓶颈

**Http2:**一个请求就对应一条流，通过 Stream ID 就可以判断该数据帧属于哪个请求

![http2](https://pic2.zhimg.com/80/v2-9ec2f3b580d86711ce10bf983705e0a5_1440w.webp)

![http2](https://pic3.zhimg.com/80/v2-33cc6b4531a4de38b94da1b2a7b6ee8a_1440w.webp)

HTTP/2 虽然通过多路复用解决了 HTTP 层的队头阻塞，但仍然存在 TCP 层的队头阻塞，因为所有请求流都共享一个滑动窗口，只要窗口靠前的位置的 ACK 丢失了，就会导致客户端的发送窗口无法向前移动，也就无法发送新的数据。

**QUIC:**给每个请求流都分配一个独立的滑动窗口，A 请求流上的丢包不会影响 B 请求流上的数据发送。但是，对于每个请求流而言，也是存在队头阻塞问题的。

![quic](https://pic2.zhimg.com/80/v2-b5a52474167933083a90ff8baa040005_1440w.webp)

## 六、QUIC连接迁移

TCP 的连接基于 4 元组：源 IP、源端口、目的 IP、目的端口，只要其中 1 个发生变化，就需要重新建立连接，QUIC 的连接是基于 64 位的 Connection ID，网络切换并不会影响 Connection ID 的变化，连接在逻辑上仍然是通的

![quic迁移](https://pic4.zhimg.com/80/v2-f82f920a417188160d2354757db44567_1440w.webp)



## 七、应用场景

- 图片小文件：明显降低文件下载总耗时，提升效率
- 视频点播：提升首屏秒开率，降低卡顿率，提升用户观看体验
- 动态请求：适用于动态请求，提升访问速度，如网页登录、交易等交互体验提升
- 弱网环境：在丢包和网络延迟严重的情况下仍可提供可用的服务，并优化卡顿率、请求失败率、秒开率、提高连接成功率等传输指标
- 大并发连接：连接可靠性强，支持页面资源数较多、并发连接数较多情况下的访问速率提升
- 加密连接：具备安全、可靠的传输性能

## 八、优缺点

**优势：**

多路复用、1rtt快速握手、精准rtt计算、连接迁移、整体加密内生安全、细致流量控制、迭代快修改方便、多路经传输、可按需扩展（Datagram数据）

**缺点：**

1. 底层传输协议：QUIC底层使用UDP进行传输，而由于内核中设计的UDP收发包机制存在一定问题，使得其批量收发包等接口性能都不如TCP，而这也同时影响QUIC报文的传输性能[3]；
2. 报文加解密：QUIC内部利用TLS对报文进行了从头到尾全方位的加密，而TCP本身并不会强制使用SSL机制来进行加密。复杂的加密过程对CPU的性能损耗不容小觑；
3. ACK处理：虽TCP的ACK报文是直接在内核中通过tcp_ack函数进行处理，而QUIC则是包括ACK在内的所有报文先收上来放到用户层后再进行处理，这就导致了额外的用户级和内核级的上下文切换以及数据从内核转移至用户的额外拷贝；
4. UDP限速（UDP  throttling）：国内不少运营商会对UDP流量进行限速处理，主要原因在于UDP这类不存在流量控制、拥塞控制的协议可能会被滥用从而抢占大量链路带宽，因此才会出现许多故意把UDP报文伪装成TCP报文（俗称fake TCP）从而绕开限速的工具。另外由于UDP五元组变化频繁，这就会导致某些状态设备在短时间内需要保存大量的UDP连接，这会给设备造成很大的压力